---
title: "Replication: The Structure of Inequality and the Politics of Redistribution"
author: "Filippo Teoldi, Zara Riaz and Julian Gerez"
date: "October 23rd, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Design declaration

We start by loading in the `DeclareDesign` package and defining the elements of the design.

* `declare_population` refers to the sample size of the study. The study concerns country-year units. In this case, there are 858 observations.
* `declare_potential_oucomes` refers to

```{r}
library('DeclareDesign')
library('panelAR')
```

## Declare Design

* Model (M): The paper tests the social affinity hypothesis that predicts middle-income voters will support redistribution policies when the distance between the middle and poor is small relative to the distance between the middle and the affluent (skew). (pg. 317)

* Inquiry (I): The study attempts to estimate parameter 

$\beta$ from the simple model

$y_i = \alpha + \beta x_i + \epsilon$. 

This can be conceptualized as the summary of all potential outcomes across conditions $\beta$ for all units. More specifically, this would be all potential outcomes of redistribution conditional on inequality measured in a variety of ways, such as skew. We assume that this model describes the true data generating process.

* Data Strategy (D): The study uses country-year data on redistribution (% change in Gini coefficients brought about by taxes and government transfers) and non-elderly social spending for 18 OECD countries for the period 1969-2005. The data is purely observational and does not involve sampling. 

* Answer Strategy (A): The authors use a variety of different answer strategies. To simplify the design declaration, we focus on their basic model specification, which can be written as:

$$
R_{i,t} = \alpha + \beta X_{i,t} + \gamma R_{i, t-1} + \epsilon_{i,t}
$$

Where for each country $i$ and year $t$, $R_{i,t}$ refers to redistribution, $\alpha$ is the constant, $\beta$ is the coefficient for a measure of inequality (e.g. we are using skew and the 9010 ratiobelow), $\gamma$ is the coefficient for redistribution lagged by one year ($R_{i,t-1}$) and  $\epsilon_{i,t}$ is the error term.

```{r}
# We model the primary specifications used to measure redistribution outcomes (Table 2, Column 7)
#Step 1: Load actual data
load("redistsample.Rdata")
data<- redistsample

#Step 2: Generate parameters
modelX <- panelAR(redist ~ dvskew + dvratio9010 + as.factor(id),
                data=redistsample, panelVar='id', timeVar='time', autoCorr='ar1',
                panelCorrMethod='pcse',rho.na.rm=TRUE, panel.weight='t-1',
                bound.rho=TRUE)
summary(modelX)
library(lmtest)
results<- coeftest(modelX) #storing coefficients from model
results
a_X <- results["(Intercept)","Estimate"]
b_X <- results["dvskew","Estimate"]
c_X <- results["dvratio9010", "Estimate"]

summary(redistsample$dvratio9010)

# Create vector of residuals
u_X <- rep(NA, 87)
names(u_X) <- rownames(redistsample)
u_X[names(modelX$residuals)] <- modelX$residuals

country_coef <- results[grepl("id", names(results[,1])), "Estimate"] # get all country fixed effects

# Create vectors of the length of the entire dataset so that each country has correct FE
country_fe <- rep(c(0, country_coef), times = as.numeric(table(redistsample$id)))

```

```{r}

# Step 1: M -- Model: Speculation on variables and relations between them
population <- declare_population(
  country = add_level(
    N = 18,  country_fe = rnorm(N),
    start = sample(1:87, 18, replace = TRUE)),
 year = add_level(
    N = 87, t = 1:N, nest = F),
  obs = cross_levels(
    by = join(country, year),
    skew = runif(n = N, min=0, max=1),
    dvratio9010 = rnorm(n = N, mean=-1.41319, sd=0.39989),
    u_i = country_fe + rnorm(N)/2
  )
)

reduce <- function(data) dplyr::filter(())
```

```{r}

# Step 2: M -- Model: Speculation on variables and relations between them
fx <- function(X, Z, u_c, u_i) {
  # redist <- panelAR(X + Z + country_fe, sd)
  redist <- a_X*X + b_Z*Z + u_c + u_i)
  return(redist)
}

outcomes<- declare_step(handler-fabricate,
          redist1= fx(skew, dvratio9010, country_fe)           
          )
```

```{r}
# Step 3 - Create Lagged DV
lagged_dv <- function(data, lambda = 0.9){
  within(data, {redist_lag <- NA
                redist_lag[t == 1] <- 1 + u_i[t == 1]
                for(j in 2:max(t)){
                  redist_lag[t==j] <- (1-lambda) + lambda*redist_lag[t==(j - 1)] + u_i[t==j]
                  }
  })
}

add_dv <- declare_step(handler = lagged_dv)
```

```{r}
  estimand <- declare_estimand(
  ATE = mean((fx(max(skew), dvratio9010, country_fe, sd = 1) -
                   fx(min(skew), dvratio9010, country_fe, sd = 1))/
                   (max(skew)-min(skew))))
```
# D -- Data Strategy: No random sampling given the study uses observational data

```{r}
estimator_1 <- declare_estimator(redist1 ~ skew +gdpgrowth
                                 , estimand = "ATE", 
                                  model = panelAR,
                                 se_type="pcse",
                                 label = "panelAR")

```

```{r}
lupu_pontusson_2011_design <- population + outcomes + add_dv + estimand + estimator_1
```
---
#Diagnosis
```{r}
library(fabricate)
kable(reshape_diagnosis(diagnose_design(lupu_pontusson_2011_design, sims = 500)))

```